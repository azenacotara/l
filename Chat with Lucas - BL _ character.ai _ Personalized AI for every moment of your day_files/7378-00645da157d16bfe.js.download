"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7378],{67378:function(e,t,n){n.d(t,{ie:function(){return E},AW:function(){return b}});var a=n(52322),i=n(2784),r=n(21236),c=n(48364),o=n(2608),l=n(8699),u=n(39395);let s=e=>new Promise(t=>{setTimeout(t,e)});async function*d(){let e=1;for(;;){let t=Math.round(100*Math.random());yield s(e+t),e*=2}}var v=n(75702),f=n(92488),p=n(47471),m=n(40789),h=n(20757),_=n(38978),C=n(84938),y=n(10386),k=n(15584);let S=(0,i.createContext)({isVoiceEnabled:!1,enableVoice:()=>null,disableVoice:()=>null,overrideVoice:()=>null,isCharacterMaybeSpeaking:!1,isCharacterSpeaking:!1,expectCharacterSpeech:()=>null,abortCharacterSpeech:()=>null,client:null,onRequestVoice:()=>null,hasVoice:!1}),g=d();function E(e){let{children:t,authToken:n,characterId:s,chatId:d,candidateId:E,onRequestVoice:b,disableActivityMonitor:I}=e,{t:T,i18n:V}=(0,y.$G)(),w="".concat(s).concat(d),[F,x]=(0,i.useState)(!1),[N,M]=(0,i.useState)(!1),[O,H]=(0,i.useState)(!1),{voiceOverride:A}=(0,u.uO)(null!=s?s:void 0),{mutate:R}=(0,C.wo)(),{mutate:U}=(0,C.et)(),{character:D}=(0,_.XS)(null!=s?s:"",V.language),{onConversationActivity:B}=(0,u.wO)(I),K=p.R.getInstance();(0,l.s)();let Q=(0,i.useMemo)(()=>new MediaStream,[]),P=(0,i.useMemo)(()=>AudioContext?new AudioContext:null,[]),[q,z]=(0,i.useState)({}),L=(0,i.useCallback)(e=>{f.sF.value=e},[]),$=(0,i.useCallback)((e,t,n)=>{s&&(f.sF.value=!!e,s&&e&&K.updateSession(s,e).catch(t=>{(0,c.H)("Failed to update voice session",{error:t,type:c.NI.Voice,extra:{characterId:s,voiceId:e}})}),r.iN.settingChanged({setting:"voice_override",referrer:t,character_id:s,value:e,searchQuery:n}),e?R({characterExternalId:s,voiceId:e},{onError:t=>{(0,c.H)("Failed to update voice override",{error:t,type:c.NI.Voice,extra:{characterId:s,voiceId:e}})}}):U({characterExternalId:s},{onError:e=>{(0,c.H)("Failed to delete voice override",{error:e,type:c.NI.Voice,extra:{characterId:s}})}}))},[s,R,U,K]),{hasVoice:W,voiceId:j,voiceQuery:G}=(0,i.useMemo)(()=>{var e;if(!s)return{hasVoice:!1};let t=null==D?void 0:D.participant__name,n=null==D?void 0:D.default_voice_id,a=null!==(e=null==A?void 0:A.voice_id)&&void 0!==e?e:n;return{hasVoice:!!t||!!a,voiceId:a,voiceQuery:t}},[s,null==D?void 0:D.participant__name,null==D?void 0:D.default_voice_id,A]),J=(0,i.useCallback)(()=>{d&&s&&E&&F&&K.abortCharacterVoice(d,s,E).then(()=>{M(!1),H(!1)}).catch(c.H)},[E,s,d,K,F]),X=(0,i.useCallback)(()=>{W?(L(!0),x(!0)):b()},[b,L,W]),Y=(0,i.useCallback)(()=>{L(!1),x(!1),J()},[J,L]),Z=(0,i.useCallback)(()=>{M(F),F&&Q&&P&&((0,h.KQ)(Q),P.resume())},[P,F,Q]),ee=(0,k.BF)(f.sF);(0,i.useEffect)(()=>{x(ee&&W)},[W,A,ee]),(0,i.useEffect)(()=>M(O),[O]),(0,i.useEffect)(()=>{if(F&&Q&&P)return(0,v.g)(Q,P,()=>{H(!0)},()=>{H(!1)},m.vx.OneWayVoice)},[P,F,Q]),(0,i.useEffect)(()=>{if(N&&!O){let e=setTimeout(()=>{O||M(!1)},m.$J);return()=>clearTimeout(e)}},[N,O]),(0,i.useEffect)(()=>{(0,h.HH)()||z({})},[N]),(0,i.useEffect)(()=>{if(!s||!d||!F||(0,h.HH)())return;let e=async()=>{M(!1),await (0,h.SW)()},t=2,a=null,i=async()=>{if(!F||!Q||!W)return;let r=(a=new AbortController).signal;r.addEventListener("abort",e);try{let{isConnectionClosed:t}=await (0,h.IR)(s,d,j,G,n,Q,r);B(),(0,o.K)(T("Voice.enabled")),Z(),await t,await e(),H(!1)}catch(n){if(r.aborted)return;await g.next(),t>0?(t--,await i()):((0,o.K)(T("Voice.error")),(0,c.H)("RTC connection error",{error:n,extra:{character_id:s,chat_id:d,voice_id:j},type:c.NI.Voice}),await e(),H(!1),x(!1))}};return i(),()=>{null==a||a.abort()}},[s,d,n,F,w,Q,q,B,T,j,G,W,Z]);let et=(0,i.useMemo)(()=>({enableVoice:X,disableVoice:Y,overrideVoice:$,expectCharacterSpeech:Z,abortCharacterSpeech:J,isVoiceEnabled:F,isCharacterMaybeSpeaking:N,isCharacterSpeaking:O,client:K,onRequestVoice:b,hasVoice:W,voiceId:j,voiceQuery:G}),[J,K,Y,X,Z,N,O,F,$,b,W,j,G]);return(0,a.jsx)(S.Provider,{value:et,children:t})}let b=()=>(0,i.useContext)(S)},8699:function(e,t,n){let a;n.d(t,{D:function(){return E},s:function(){return S}});var i=n(21236),r=n(48364),c=n(2608),o=n(35740),l=n(55274),u=n(89956),s=n(92488),d=n(47471),v=n(20757),f=n(57960),p=n(59887),m=n(93033),h=n(38694),_=n(16575),C=n(2784),y=n(10386),k=n(15584);let S=()=>{var e;let{user:t,token:n}=(0,o.a)(),a=null==t?void 0:null===(e=t.user)||void 0===e?void 0:e.id;(0,C.useEffect)(()=>{a&&d.R.getInstance().setUserId(a)},[a]),(0,C.useEffect)(()=>{n&&d.R.getInstance().setAuthToken(n)},[n])},g=e=>{let[t,n]=(0,C.useState)(!1),[a,i]=(0,C.useState)(!1),[c,o]=(0,C.useState)(f.aB.Unmuted),l=(0,C.useCallback)((e,t)=>{"system"===e?n(e=>null!=t?t:!e):i(e=>null!=t?t:!e)},[]);return(0,C.useEffect)(()=>{let n=async()=>{let n=t||a,i=e.localParticipant.getTrackPublication(_.fQ.Source.Microphone);if(i)try{let e;i.isMuted!==n&&await (n?i.mute():i.unmute()),e=i.isMuted?a?f.aB.UserMuted:f.aB.SystemMuted:f.aB.Unmuted,o(e)}catch(e){(0,r.H)("Error muting microphone",{error:e,extra:{systemMuteRequested:t,userMuteRequested:a}})}};try{n()}catch(e){(0,r.H)("Error handling mute",{error:e,type:r.NI.Voice})}},[t,a,e]),{muteMicrophone:l,microphoneMuteStatus:c}},E=(e,t,n)=>{let{characterId:o}=(0,l.AU)(),{stopCharacterSpeaking:S}=(0,u.c9)(),E=(0,k.BF)(s.OO),[b]=(0,C.useState)(()=>new _.du),[I,T]=(0,k.zb)(f.Fe.unconnected),[V,w]=(0,C.useState)(f.Td.Initializing),[F,x]=(0,C.useState)(!1),{muteMicrophone:N,microphoneMuteStatus:M}=g(b),{t:O}=(0,y.$G)(),{mutate:H}=(0,m.pC)(),A=(0,k.BF)(s.yc);(0,C.useEffect)(()=>{b.prepareConnection(h.Rz.LIVEKIT_URL).catch(e=>{(0,r.H)("Error preparing rtc connection",{error:e,type:r.NI.Voice})})},[b]);let R=(0,C.useCallback)(()=>{(0,c.K)(O("Voice.voice-error"),void 0,"destructive")},[O]),U=(0,C.useRef)(null),D=(0,C.useCallback)((e,t)=>{I.value!==e&&(i.iN.voiceRtcConnectionStatusChange({referrer:"MultimediaConnectionHook",connection_status:e,...null!=t?t:{}}),s.UU.value=e,I.value=e)},[I]);(0,C.useEffect)(()=>{let e=null;return I.value===f.Fe.connected&&(null==E?void 0:E.status)==="requested"&&(e=setTimeout(()=>{(0,r.H)("Voice playback request timed out",{type:r.NI.Voice}),S(),s.OO.value={status:"done",timestamp:Date.now()}},h.Rz.VOICE_MAX_DURATION_FOR_REQUESTED_STATE_MS)),()=>{e&&clearTimeout(e)}},[S,I,E]);let B=(0,C.useCallback)(async e=>{e?D(f.Fe.failed):I.value===f.Fe.connecting||I.value===f.Fe.disconnecting?D(f.Fe.disconnecting):D(f.Fe.unconnected),await b.disconnect(),U.current&&clearTimeout(U.current),s.OO.value={status:"done",timestamp:Date.now()}},[D,I,b]),K=(0,C.useCallback)(()=>{U.current&&clearTimeout(U.current),U.current=setTimeout(()=>{e.value=!1,(0,c.K)(O("Voice.voice-inactivity")),i.iN.voiceRtcConnectionStatusChange({referrer:"MultimediaConnectionHook",connection_status:"inactivity_timeout"})},h.Rz.VOICE_INACTIVITY_TIMEOUT_MS)},[O,e]);(0,C.useEffect)(()=>{I.value===f.Fe.connected&&A>0&&K()},[K,I,A]);let Q=(0,C.useCallback)(e=>{if(e)try{w(e)}catch(e){(0,r.H)("Error updating turn state",{error:e,type:r.NI.Voice})}},[]),P=(0,C.useCallback)(async i=>{let{chatId:l,voiceId:u,voiceQuery:s,callArgs:m}=i,h=!!m;try{if(I.value===f.Fe.connecting){(0,p.BS)("already  connecting");return}if(I.value===f.Fe.connected){(0,p.BS)("already  connected");return}if(I.value===f.Fe.disconnecting){(0,p.BS)("in the process of disconnecting");return}let e={room_id:l,two_way:h,character_id:o,voice_id:u,voice_query:s};D(f.Fe.connecting,e);let i=u?{[o]:u}:{},r=u?{}:{[o]:s};a=Date.now();let y=await d.R.getInstance().joinOrCreateSession(l,i,r,void 0,h,null==m?void 0:m.userAuthToken,null==m?void 0:m.username);d.R.getInstance().setCurrentSession(null==y?void 0:y.session);let k=y.lkUrl,S=y.lkToken;if(b.on(_.TQ.TrackSubscribed,e=>{e&&t&&(t.addTrack(e.mediaStreamTrack),(0,v.KQ)(t))}),await b.connect(k,S,{autoSubscribe:!0}),K(),(0,c.K)(O("Voice.voice-on")),D(f.Fe.connected,{...e,connection_time_ms:a?Date.now()-a:void 0,rtc_type:"livekit"}),h){var C;await b.localParticipant.setMicrophoneEnabled(!0,{noiseSuppression:!0,echoCancellation:!0});let e=null===(C=b.localParticipant.getTrackPublication(_.fQ.Source.Microphone))||void 0===C?void 0:C.track;n&&e&&(null==n||n.addTrack(null==e?void 0:e.mediaStreamTrack))}}catch(t){e.value=!1,I.value===f.Fe.disconnecting?(B(!1),D(f.Fe.unconnected)):(B(!0),t instanceof Error&&(null==t?void 0:t.name)==="NotAllowedError"?((0,c.K)(O("Voice.microphone-error"),1e4,"destructive",O("Voice.you-probably-havent-granted-microphone-permissions")),(0,r.H)("Microphone permissions not granted",{error:t,type:r.NI.Voice,extra:{two_way:h}})):(R(),(0,r.H)("RTC connection error",{error:t,type:r.NI.Voice,extra:{two_way:h}})))}},[I.value,o,D,b,K,O,n,t,e,B,R]),q=(0,C.useCallback)((t,n)=>{e.value=!1,R(),(0,r.H)("livekit disconnect error",{error:t,type:r.NI.Voice,extra:{...n,room_name:b.name,rtc_connection_status:I.value}})},[R,e,b,I]);return(0,C.useEffect)(()=>(b.localParticipant.on(_.dd.IsSpeakingChanged,e=>{x(e)}),b.on(_.TQ.Disconnected,e=>{if(I.value===f.Fe.disconnecting){D(f.Fe.unconnected);return}e===_.W4.CLIENT_INITIATED?D(f.Fe.unconnected):q(e)}).on(_.TQ.DataReceived,e=>{let t=new TextDecoder().decode(e);try{let e=JSON.parse(t);"speechStarted"===e.event?(s.OO.value={status:"playing",timestamp:Date.now()},e.candidateId&&(s.q9.value=e.candidateId),K()):"speechEnded"===e.event?s.OO.value={status:"done",timestamp:Date.now()}:"TurnState"===e.event?e.state&&Q(e.state):"ParticipantDisconnected"===e.event&&q("participant disconnected",{extra:{participant_id:e.participantId,source:"data_event"}})}catch(e){(0,r.H)("Failed to parse livekit room event",{error:e,type:r.NI.Voice})}}).on(_.TQ.TrackSubscriptionFailed,(e,t,n)=>{R(),(0,r.H)("livekit track subscription failed",{error:n,type:r.NI.Voice})}).on(_.TQ.ParticipantDisconnected,e=>{q("participant disconnected",{extra:{participant_id:e.identity,source:"participant_disconnected_event"}})}),()=>{b.removeAllListeners()}),[B,K,b,D,H,R,q,Q,I]),{mconnect:(0,C.useCallback)(t=>{let{chatId:n,voiceId:a,voiceQuery:i,callArgs:r}=t;e.value&&o&&P({chatId:n,voiceId:a,voiceQuery:i,characterId:o,callArgs:r})},[e.value,o,P]),mdisconnect:B,muteMicrophone:N,microphoneMuteStatus:M,rtcConnectionStatus:T,voiceCallTurnStatus:V,isUserSpeaking:F}}},89956:function(e,t,n){n.d(t,{E$:function(){return g},c9:function(){return S}});var a=n(21236),i=n(48364),r=n(2608),c=n(55274),o=n(39395),l=n(92488),u=n(47471),s=n(57960),d=n(50413),v=n(28450),f=n(47022),p=n(50926);n(38978);var m=n(84938),h=n(2784),_=n(10386),C=n(15584);let y=(e,t)=>e===s.Fe.connected&&((null==t?void 0:t.status)==="requested"||(null==t?void 0:t.status)==="playing"),k=()=>{var e;let{character:t,characterId:n}=(0,c.AU)(),{voiceOverride:a}=(0,o.uO)(n);if(!t)return{hasVoice:!1};let i=t.default_voice_id,r=null!==(e=null==a?void 0:a.voice_id)&&void 0!==e?e:i,l=t.participant__name;return{hasVoice:!!r||!!l,voiceId:r,voiceQuery:l}},S=()=>{let{character:e}=(0,c.AU)(),t=(0,C.BF)(l.UU),n=(0,C.BF)(l.OO),{hasVoice:r}=k(),o=(0,h.useCallback)(async()=>{let t=y(l.UU.value,l.OO.value),n=l.jN.value,c=l.q9.value;if(r&&t){if(!n||!e||!c){(0,i.H)("failed to stop character speaking - invalid params",{extra:{chatId:n,characterId:null==e?void 0:e.external_id,lastCandidateId:c,isCharacterSpeaking:t}});return}a.iN.voiceStopCharcterSpeaking({referrer:"voices_hook",character_id:null==e?void 0:e.external_id,chat_id:n,last_candidate_id:c}),await u.R.getInstance().abortCharacterVoice(n,null==e?void 0:e.external_id,c)}},[e,r]);return{isCharacterSpeaking:y(t,n),stopCharacterSpeaking:o}},g=()=>{let{t:e}=(0,_.$G)(),{character:t}=(0,c.AU)(),[n,a]=(0,h.useState)(),{mutate:u}=(0,m.et)(),{hasVoice:s,voiceQuery:C,voiceId:y}=k(),S=null==t?void 0:t.external_id,{voiceOverride:g}=(0,o.uO)(S);(0,h.useEffect)(()=>{t&&!t.external_id&&(0,i.H)("Character has no external_id",{extra:{character:t}})},[t]);let{subscribe:E}=(0,f.m)(),{isLoading:b,error:I}=(0,m.Kl)(y,!1),T=!!y&&b;return(0,h.useEffect)(()=>{(0,v.i$)(null==I?void 0:I.response)&&S&&y&&(null==g?void 0:g.voice_id)===y&&((0,r.K)(e("Calls.voice-unavailable")),u({characterExternalId:S},{onError:t=>{(0,r.A)(e("Error.something-went-wrong")),(0,i.H)("Failed to delete voice override",{error:t,type:i.NI.Voice,extra:{characterId:S,voiceId:y}})}}))},[S,u,g,I,y,e]),(0,h.useEffect)(()=>{if(!S||!t)return;let{unsubscribe:e}=E(S,(e,t,n)=>{let i=null==n?void 0:n.chat_id;a(i),i!==d.z4&&(l.jN.value=i)},p.Em.Neo,{character:t});return e},[E,S,t]),{voiceId:I?void 0:y,voiceQuery:C,hasVoice:s,chatId:n,isVoiceLoading:T}}},75702:function(e,t,n){n.d(t,{g:function(){return i},s:function(){return c}});var a=n(40789);let i=function(e,t,n,i,r){let c,l,u,s,d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:a.Fd,v=!0,f=!1,p=!1,m=null,h=()=>{c=t.createMediaStreamSource(e),s=t.createAnalyser(),c.connect(s),s.fftSize=32,l=new Float32Array(u=s.frequencyBinCount)},_=()=>{if(!v)return;s.getFloatTimeDomainData(l),p&&o(r,l);let e=!1;for(let t=0;t<u;t++)if(Math.abs(l[t])>.1){e=!0;break}f!==e&&(f=e,null!=m&&clearTimeout(m),m=setTimeout(()=>{m=null,p!==f&&v&&(p=f,f?n():i())},f?0:d)),requestAnimationFrame(_)},C=()=>e.getAudioTracks().length>0;if(!C()){let t=()=>{C()&&(h(),_())};return e.addEventListener("addtrack",t),()=>{v=!1,e.removeEventListener("addtrack",t)}}return h(),_(),()=>{t.close(),v=!1}},r={},c=(e,t)=>(r[e]||(r[e]=[]),r[e].push(t),()=>{r[e]=r[e].filter(e=>e!==t),0===r[e].length&&delete r[e]}),o=(e,t)=>{if(r[e])for(let n of r[e])n(t)}},40789:function(e,t,n){var a,i;n.d(t,{$J:function(){return c},Fd:function(){return r},vx:function(){return a}});let r=3e3,c=5e3;(i=a||(a={})).OneWayVoice="OneWayVoice",i.VoiceCallsMediaStream="VoiceCallsMediaStream",i.VoiceCallsMicrophoneStream="VoiceCallsMicrophoneStream"}}]);